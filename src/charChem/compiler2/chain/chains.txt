Описание концепции цепей/подцепей
---------------------------------
Здесь используются термины, которые не являются общеупотребительными в химии.
Они являются специфичными для решения данной задачи.
Сама задача больше геометрическая, чем химическая.

Для описания структурной части формул используется последовательность узлов и связей.
Узлы могут быть описаны любым количеством атомов (радикалов, абстрактных элементов и комментариев).
Например, CH3CH2OH - это формула из одного узла.
CH3-CH2-OH - Здесь уже три узла и две связи.
Однако, согласно правилам скелетных формул, связи могут перечисляться без узлов.
Например, /\/\ (Pentane)
Тем не менее, узлы в таких случаях создаются автоматически.
Они состоят из 1 углерода и соответствующего числа атомов водорода.
И называются "автоматические узлы". При выводе они считаются невидимыми,
но учитываются при вычислении таких характеристих формулы как масса или брутто-формула.

Химические связи могут быть описаны разными способами. Основные:
- краткие описания - для шестиугольных структур при помощи / - \
- относительные или полигональные - _p, _q
- универсальные - _()

Для описания нелинейных структур используются следующие приемы:
- ветвление < >
- автоматическая закольцовка. Например, -|`-`| циклобутан
- геометрическое наложение двух связей (независимо от способа описания) приводит к объединению
- указание целевого узла (ссылка) через #
- использование нескольких цепей через ;
(общая концепция напомпинае рисование формулы карандашом на бумаге)

Цепочкой считается последовательность узлов и связей до разделителя ; или до конца формулы.
Однако, разные цепи в итоге должны быть объединены в одну при помощи ссылок.
Например, метан: "H-C-H; H|#2|H"

Для автоматической закольцовки и геометрического наложения необходимо отслеживать координаты "карандаша"
и сопоставлять с координтами уже существующих связей.

Чаще всего связи соединяют центры узлов. Такие связи называются жесткими.
Их особенность в том, что на этапе компиляции описания можно вычислить геометрические координаты связанных с ними узлов.
Если бы все связи были жесткими, то после компиляции можно было бы знать координаты всех узлов формулы.
Система координат, которая используется при компиляции, называется мировой (world coordinates).
При отрисовке графического представления формулы мы переходим к системе видовых координат (view coordinates).
Обычно на преобразование из мировых координат в видовые влияют харатеристики используемого шрифта.
В частности, единица в мировых координатах по-умолчанию равна высоте шрифта в видовых координатах.

Ситуация осложняется тем, что существуют связи особого характера. Например: CH3-COOH
Здесь связь не между центрами, а между границами графических изображений двух узлов.
Такие связи называются мягкими.
На этапе компиляции не известны характеристики шрифта, поэтому наличие мягкой связи в формуле означает,
что мировые координаты соединяемых узлов не определены.
Такие разрывы делят цепь на подцепи. Каждая подцепь существует в своей системе мировых координат.
Объединение происходит лишь на этапе отрисовки уже в видовых координатах.

Итого, для компиляции нужен механизм, который:
 - контролирует создание цепей и подцепей
 - отслеживает координаты "карандаша"
 - фиксирует факт зацикливания для жестких связей в пределах подцепи.
 - объединяет цепи при связывании по ссылке.
 - операции openBrunch, closeBrunch для ветвления

Дополнительные сущности:
- словарь меток для ссылок
- сквозной список узлов для ссылок по номеру (ChemAgent.nodes)

ChainSys берет на себя эти функции и представляет мост (bridge - design pattern)
между ChemCompiler и перечисленной функциональностью.
Сам объект ChainSys представляет фасад (facade - design pattern) для рабочих структур.

Кроме того, для идентификации цепей и подцепей используются числовые идентификаторы.
Они являются полями ChemNode: chain, subChain.
Их затем удобно использовать при графической отрисовке.
Обычно в итоге вся формула объединяется в одну цепь.
Но в редких случаях можно оставить несколько цепей.
Тогда при выводе они будут выглядеть как независимые формулы, выводимые слева направо через пробел.
Идентификаторы подцепей тоже очень полезны для вычисления видовых координат.